stages:
  - buildServer
  - publish-image-cdp-ecrs

workflow:
  rules:
    - if: $CI_COMMIT_TAG

default:
  tags:
    - docker_image
  image: dckregistry.exacaster.com:5000/docker/exagit-runner-artifactory:latest

variables:
    ECR: 'true'
    CDP_TRIGGER: 'false'

include:
  - https://exagit.exacaster.com/exacaster/ci-commons/raw/master/cdp/.publish-image-cdp-ecrs.yml

publish-image-cdp-ecrs:
  variables:
    TAG: $CI_COMMIT_TAG

buildServer:
  stage: buildServer
  image: dckregistry.exacaster.com:5000/docker/java/11-jre-slim:master
  script: |
    export TAG=${CI_COMMIT_TAG}
    export SERVER_IMAGE="${CI_REGISTRY_IMAGE}/server"
    cd server/
    ./gradlew dockerBuild -PIMAGE=${SERVER_IMAGE} -PTAG=${TAG}
    ./gradlew dockerPush -PIMAGE=${SERVER_IMAGE} -PTAG=${TAG}

